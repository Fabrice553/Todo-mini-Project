<% layout('layout', { title: 'Your Tasks', username }) %>

<section>
  <h2>Your Tasks</h2>

  <form method="get" action="/tasks" style="margin-bottom:1rem;">
    <label>Filter:
      <select name="state" onchange="this.form.submit()">
        <option value="all" <%= state==='all' ? 'selected' : '' %>>All</option>
        <option value="pending" <%= state==='pending' ? 'selected' : '' %>>Pending</option>
        <option value="completed" <%= state==='completed' ? 'selected' : '' %>>Completed</option>
        <option value="deleted" <%= state==='deleted' ? 'selected' : '' %>>Deleted</option>
      </select>
    </label>
  </form>

  <form method="post" action="/tasks/create">
    <input name="title" placeholder="New task title" required />
    <button type="submit">Add</button>
  </form>

  <div style="margin-top:1rem;">
    <% if (!tasks.length) { %>
      <p>No tasks yet.</p>
    <% } else { %>
      <% tasks.forEach(task => { %>
        <div class="task">
          <div>
            <div><strong><%= task.title %></strong></div>
            <div class="meta">created <%= task.createdAt.toLocaleString() %> â€¢ <%= task.state %></div>
          </div>
          <div class="actions">
            <% if (task.state !== 'completed') { %>
              <form method="post" action="/tasks/<%= task._id %>/state" style="display:inline">
                <input type="hidden" name="state" value="completed" />
                <button type="submit">Complete</button>
              </form>
            <% } %>
            <% if (task.state !== 'deleted') { %>
              <form method="post" action="/tasks/<%= task._id %>/state" style="display:inline">
                <input type="hidden" name="state" value="deleted" />
                <button type="submit">Delete</button>
              </form>
            <% } %>
            <% if (task.state !== 'pending') { %>
              <form method="post" action="/tasks/<%= task._id %>/state" style="display:inline">
                <input type="hidden" name="state" value="pending" />
                <button type="submit">Reset</button>
              </form>
            <% } %>
          </div>
        </div>
      <% }) %>
    <% } %>
  </div>
</section>